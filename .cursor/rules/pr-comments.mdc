---
description: Extrai comentÃ¡rios de discussÃµes do PR via gh CLI e gera relatÃ³rio em Markdown
alwaysApply: false
---

# PR Comments Extractor

Quando o usuÃ¡rio pedir para **"puxar do coderabbit"** (ou variantes como "extrai as sugestÃµes", "pega os comentÃ¡rios do PR", etc.), execute o fluxo abaixo.

## 1. Detectar branch e nÃºmero do PR

```bash
branch=$(git branch --show-current)
prNum=$(gh pr list --head "$branch" --json number --jq '.[0].number')
```

Se nÃ£o encontrar PR, avisar usuÃ¡rio e nÃ£o prosseguir.

## 2. Gerar relatÃ³rio em Markdown

```bash
branch=$(git branch --show-current)
prNum=$(gh pr list --head "$branch" --json number --jq '.[0].number')
prInfo=$(gh pr view $prNum --json title,author --jq '{title, author: .author.login}')
comments=$(gh api repos/{owner}/{repo}/pulls/$prNum/comments)

mkdir -p .cursor/pr-comments
output=".cursor/pr-comments/pr-$prNum.md"

cat > "$output" <<EOF
# RelatÃ³rio de ComentÃ¡rios do PR #$prNum

**TÃ­tulo**: $(echo "$prInfo" | jq -r '.title')
**Autor**: $(echo "$prInfo" | jq -r '.author')
**Branch**: $branch
**Gerado em**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

## ğŸ“Š EstatÃ­sticas

EOF

total=$(echo "$comments" | jq 'length')
files=$(echo "$comments" | jq -r 'map(.path) | unique | length')
authors=$(echo "$comments" | jq -r 'map(.user.login) | unique | join(", ")')

echo "- Total de comentÃ¡rios: $total" >> "$output"
echo "- Arquivos afetados: $files" >> "$output"
echo "- Autores: $authors" >> "$output"

echo "" >> "$output"
echo "## ğŸ“ ComentÃ¡rios por Arquivo" >> "$output"
echo "" >> "$output"

echo "$comments" | jq -r 'map(.path) | unique | .[]' | while read -r file; do
  cat >> "$output" <<EOF

### $file

EOF
  echo "$comments" | jq --arg f "$file" '[.[] | select(.path == $f)]' | jq -c '.[]' | while IFS= read -r comment; do
    user=$(echo "$comment" | jq -r '.user.login')
    date=$(echo "$comment" | jq -r '.created_at')
    line=$(echo "$comment" | jq -r 'if .line then .line else .start_line end')
    link=$(echo "$comment" | jq -r '.html_url')
    body=$(echo "$comment" | jq -r '.body')

    cat >> "$output" <<EOF

**[$user]** â€¢ $date â€¢ [Linha $line]($link)

---

**Body:**

$body

---
EOF
  done
done

echo "RelatÃ³rio gerado: $output"
```

## 3. Confirmar ao usuÃ¡rio

ApÃ³s executar, informar:
- Caminho do arquivo gerado
- Resumo estatÃ­stico (total comentÃ¡rios, arquivos afetados, autores)